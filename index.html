<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-progress {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏°‡∏ß.‡∏™.</h1>
        </header>



        <!-- Apps Script Guide Modal -->
        <div id="guideModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script + Google Drive</h3>
                        <button onclick="closeGuide()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-6 text-sm">
                        <div>
                            <h4 class="font-semibold text-indigo-600 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Sheet</h4>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                                <li>‡∏™‡∏£‡πâ‡∏≤‡∏á Google Sheet ‡πÉ‡∏´‡∏°‡πà</li>
                                <li>‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å: ID, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£, ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°, ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á, ‡∏™‡∏†‡∏≤‡∏û, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô, ‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏°, ‡∏£‡∏π‡∏õ‡∏Ñ‡∏∑‡∏ô</li>
                            </ol>
                        </div>

                        <div>
                            <h4 class="font-semibold text-indigo-600 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive</h4>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                                <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://drive.google.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">drive.google.com</a></li>
                                <li>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô"</li>
                                <li>‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID ‡∏à‡∏≤‡∏Å URL (‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á /folders/)</li>
                                <li>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô "Anyone with the link can view"</li>
                            </ol>
                        </div>

                        <div>
                            <h4 class="font-semibold text-indigo-600 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á Apps Script</h4>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                                <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://script.google.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">script.google.com</a></li>
                                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "New Project"</li>
                                <li>‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏ß‡∏≤‡∏á</li>
                                <li>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç SHEET_ID ‡πÅ‡∏•‡∏∞ DRIVE_FOLDER_ID ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</li>
                                <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</li>
                            </ol>
                        </div>

                        <div>
                            <h4 class="font-semibold text-indigo-600 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: Deploy Web App</h4>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Deploy" > "New deployment"</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Type: "Web app"</li>
                                <li>Execute as: "Me"</li>
                                <li>Who has access: "Anyone"</li>
                                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Deploy"</li>
                                <li>‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Drive ‡πÅ‡∏•‡∏∞ Sheets</li>
                                <li>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Web app URL</li>
                            </ol>
                        </div>

                        <div>
                            <h4 class="font-semibold text-indigo-600 mb-2">‡πÇ‡∏Ñ‡πâ‡∏î Apps Script (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Google Drive):</h4>
                            <div class="bg-gray-100 p-4 rounded-md overflow-x-auto">
                                <pre class="text-xs"><code>// ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission ‡πÉ‡∏ô Apps Script ‡∏Å‡πà‡∏≠‡∏ô!
// ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Extensions > Apps Script > Services > ‡πÄ‡∏û‡∏¥‡πà‡∏° Google Drive API

const SHEET_ID = '‡πÉ‡∏™‡πà Google Sheet ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
let DRIVE_FOLDER_ID = '‡πÉ‡∏™‡πà Google Drive Folder ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà'; // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Permission ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Drive
function onOpen() {
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ç‡∏≠ Permission ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  try {
    DriveApp.getRootFolder();
    SpreadsheetApp.getActiveSpreadsheet();
  } catch (e) {
    console.log('Permission setup required');
  }
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function createFolder() {
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Permission ‡∏Å‡πà‡∏≠‡∏ô
    try {
      DriveApp.getRootFolder();
    } catch (permError) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          error: '‡πÑ‡∏°‡πà‡∏°‡∏µ Permission ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Drive - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ setupPermissions() ‡∏Å‡πà‡∏≠‡∏ô'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
    const folder = DriveApp.createFolder('‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô-' + new Date().getTime());
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå
    folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.EDIT);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DRIVE_FOLDER_ID
    DRIVE_FOLDER_ID = folder.getId();
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        folderId: folder.getId(),
        folderName: folder.getName(),
        folderUrl: folder.getUrl(),
        message: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ID: ${folder.getId()}`
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false, 
          error: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const data = JSON.parse(e.postData.contents);
    
    // Handle image upload to Google Drive
    if (data.action === 'uploadImage') {
      return uploadImageToDrive(data);
    }
    
    // Handle test Drive connection
    if (data.action === 'testDrive') {
      return testDriveConnection();
    }
    
    // Handle manual permission setup
    if (data.action === 'setupPermissions') {
      return setupPermissions();
    }
    
    // Handle create folder
    if (data.action === 'createFolder') {
      return createFolder();
    }
    
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    
    const lastRow = sheet.getLastRow();
    if (lastRow === 0) {
      sheet.appendRow([
        'ID', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', '‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°', '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á', '‡∏™‡∏†‡∏≤‡∏û', 
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô', '‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏°', '‡∏£‡∏π‡∏õ‡∏Ñ‡∏∑‡∏ô'
      ]);
    }
    
    if (data.action === 'add') {
      sheet.appendRow([
        data.id || '',
        data.borrowerName || '',
        data.borrowerPhone || '',
        data.itemName || '',
        data.quantity || '',
        data.borrowDate || '',
        data.returnDate || '',
        data.actualReturnDate || '',
        data.condition || '',
        data.status || '‡∏¢‡∏∑‡∏°',
        data.notes || '',
        data.returnNotes || '',
        data.borrowImageUrls || '',
        data.returnImageUrls || ''
      ]);
      
      return ContentService
        .createTextOutput(JSON.stringify({
          success: true, 
          message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
        }))
        .setMimeType(ContentService.MimeType.JSON);
        
    } else if (data.action === 'update') {
      const values = sheet.getDataRange().getValues();
      let updated = false;
      
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] == data.id) {
          sheet.getRange(i + 1, 8).setValue(data.actualReturnDate || '');
          sheet.getRange(i + 1, 9).setValue(data.condition || '');
          sheet.getRange(i + 1, 10).setValue('‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
          sheet.getRange(i + 1, 12).setValue(data.returnNotes || '');
          if (data.returnImageUrls) {
            sheet.getRange(i + 1, 14).setValue(data.returnImageUrls);
          }
          updated = true;
          break;
        }
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({
          success: updated,
          message: updated ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false, 
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission
function setupPermissions() {
  try {
    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Google Drive
    const rootFolder = DriveApp.getRootFolder();
    
    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Google Sheets
    const sheet = SpreadsheetApp.openById(SHEET_ID);
    
    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Folder ID ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (DRIVE_FOLDER_ID) {
      const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Google Drive ‡πÅ‡∏•‡∏∞ Sheets ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function uploadImageToDrive(data) {
  try {
    if (!DRIVE_FOLDER_ID) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          error: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ DRIVE_FOLDER_ID ‡πÉ‡∏ô Apps Script'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Permission ‡∏Å‡πà‡∏≠‡∏ô
    try {
      DriveApp.getRootFolder();
    } catch (permError) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          error: '‡πÑ‡∏°‡πà‡∏°‡∏µ Permission ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Drive - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ setupPermissions() ‡∏Å‡πà‡∏≠‡∏ô'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const base64Data = data.imageData.split(',')[1];
    const blob = Utilities.newBlob(
      Utilities.base64Decode(base64Data), 
      data.mimeType, 
      data.fileName
    );
    
    const file = folder.createFile(blob);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå
    try {
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    } catch (shareError) {
      console.log('Warning: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ');
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        fileId: file.getId(),
        fileUrl: file.getUrl(),
        viewUrl: `https://drive.google.com/file/d/${file.getId()}/view`,
        directUrl: `https://drive.google.com/uc?id=${file.getId()}&export=view`
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function testDriveConnection() {
  try {
    if (!DRIVE_FOLDER_ID) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          error: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ DRIVE_FOLDER_ID ‡πÉ‡∏ô Apps Script'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Permission ‡∏Å‡πà‡∏≠‡∏ô
    try {
      DriveApp.getRootFolder();
    } catch (permError) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          error: '‡πÑ‡∏°‡πà‡∏°‡∏µ Permission ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Drive - ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission" ‡∏Å‡πà‡∏≠‡∏ô'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå: "${folder.getName()}" (ID: ${DRIVE_FOLDER_ID})`
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    let errorMsg = error.toString();
    if (errorMsg.includes('getFolderById')) {
      errorMsg = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Folder ID ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á';
    } else if (errorMsg.includes('Unexpected error')) {
      errorMsg = '‡πÑ‡∏°‡πà‡∏°‡∏µ Permission ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Drive - ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission"';
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: errorMsg
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    const lastRow = sheet.getLastRow();
    
    if (lastRow === 0) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: true, 
          data: []
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);
    
    const records = rows.map(row => {
      const record = {};
      headers.forEach((header, index) => {
        record[header] = row[index] || '';
      });
      return record;
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true, 
        data: records
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false, 
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-lg mb-8">
            <div class="flex border-b">
                <button onclick="showTab('borrow')" id="borrowTab" 
                        class="flex-1 py-3 px-4 text-center font-medium border-b-2 border-indigo-500 text-indigo-600">
                    üì§ ‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á
                </button>
                <button onclick="showTab('return')" id="returnTab" 
                        class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    üì• ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á
                </button>
                <button onclick="showTab('history')" id="historyTab" 
                        class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                </button>
            </div>

            <!-- Borrow Form -->
            <div id="borrowSection" class="p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">üì§ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á</h2>
                <form id="borrowForm" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label for="borrowerName" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</label>
                            <input type="text" id="borrowerName" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="borrowerPhone" class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                            <input type="tel" id="borrowerPhone" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label for="itemName" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label>
                            <input type="text" id="itemName" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                            <input type="number" id="quantity" min="1" value="1" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label for="borrowDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label>
                            <input type="date" id="borrowDate" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="returnDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô (‡∏Å‡∏≥‡∏´‡∏ô‡∏î)</label>
                            <input type="date" id="returnDate" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="notes" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div>
                        <label for="borrowImages" class="block text-sm font-medium text-gray-700 mb-2">üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</label>
                        <input type="file" id="borrowImages" multiple accept="image/*" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ (JPG, PNG, GIF) - ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive</p>
                        <div id="borrowImagePreview" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                        <div id="borrowUploadProgress" class="hidden mt-2">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="upload-progress h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive...</p>
                        </div>
                    </div>
                    <button type="submit" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-md font-medium transition-colors">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°
                    </button>
                </form>
            </div>

            <!-- Return Form -->
            <div id="returnSection" class="p-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">üì• ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á</h2>
                <div class="mb-4">
                    <label for="searchBorrow" class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</label>
                    <input type="text" id="searchBorrow" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div id="borrowList" class="space-y-3 mb-6">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
                <form id="returnForm" class="space-y-4 hidden">
                    <input type="hidden" id="returnBorrowId">
                    <div class="bg-gray-50 p-4 rounded-md">
                        <h3 class="font-medium text-gray-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3>
                        <div id="returnItemInfo"></div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label for="actualReturnDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á</label>
                            <input type="date" id="actualReturnDate" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="condition" class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á</label>
                            <select id="condition" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û</option>
                                <option value="‡∏î‡∏µ">‡∏î‡∏µ</option>
                                <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢">‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="returnNotes" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</label>
                        <textarea id="returnNotes" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div>
                        <label for="returnImages" class="block text-sm font-medium text-gray-700 mb-2">üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</label>
                        <input type="file" id="returnImages" multiple accept="image/*" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ (JPG, PNG, GIF) - ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive</p>
                        <div id="returnImagePreview" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                        <div id="returnUploadProgress" class="hidden mt-2">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="upload-progress h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive...</p>
                        </div>
                    </div>
                    <button type="submit" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md font-medium transition-colors">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô
                    </button>
                </form>
            </div>

            <!-- History Section -->
            <div id="historySection" class="p-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2>
                <div class="mb-4 flex gap-4">
                    <input type="text" id="historySearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥..." 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="loadHistory()" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors">
                        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
                <div id="historyList" class="space-y-3">
                    <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden fixed top-4 right-4 p-4 rounded-md shadow-lg z-50"></div>

        <!-- Image Modal -->
        <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div class="relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden">
                <button onclick="closeImageModal()" 
                        class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75 z-10">
                    √ó
                </button>
                <img id="modalImage" src="" alt="" class="max-w-full max-h-[90vh] object-contain">
                <div class="p-4 bg-white">
                    <p id="modalImageName" class="text-sm text-gray-600"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isConnected = false;
        let appsScriptUrl = 'https://script.google.com/macros/s/AKfycbwvq01WvDz69NIHE8rPgXLMeS1ClAE4wNFFDMdS31UAMxtttcDihUAfNfZ-WcRZlpOi/exec';
        let driveEnabled = false;

        // Set today's date as default
        document.getElementById('borrowDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('actualReturnDate').value = new Date().toISOString().split('T')[0];

        // Image handling
        let borrowImages = [];
        let returnImages = [];
        let borrowImageUrls = [];
        let returnImageUrls = [];

        // Handle borrow image selection
        document.getElementById('borrowImages').addEventListener('change', function(e) {
            handleImageSelection(e.target.files, 'borrow');
        });

        // Handle return image selection
        document.getElementById('returnImages').addEventListener('change', function(e) {
            handleImageSelection(e.target.files, 'return');
        });

        function handleImageSelection(files, type) {
            const imageArray = type === 'borrow' ? borrowImages : returnImages;
            const previewContainer = document.getElementById(type + 'ImagePreview');
            
            // Clear previous images
            imageArray.length = 0;
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            name: file.name,
                            data: e.target.result,
                            size: file.size,
                            type: file.type
                        };
                        imageArray.push(imageData);
                        
                        // Create preview
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'relative group';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}" 
                                 class="w-full h-20 object-cover rounded-md border border-gray-300">
                            <button type="button" onclick="removeImage(${index}, '${type}')" 
                                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                                √ó
                            </button>
                            <p class="text-xs text-gray-500 mt-1 truncate">${file.name}</p>
                        `;
                        previewContainer.appendChild(previewDiv);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function removeImage(index, type) {
            const imageArray = type === 'borrow' ? borrowImages : returnImages;
            const previewContainer = document.getElementById(type + 'ImagePreview');
            
            imageArray.splice(index, 1);
            previewContainer.children[index].remove();
        }



        // Upload images to Google Drive
        async function uploadImagesToDrive(images, type) {
            if (!driveEnabled || !appsScriptUrl || images.length === 0) {
                return [];
            }
            
            const progressContainer = document.getElementById(type + 'UploadProgress');
            const progressBar = progressContainer.querySelector('.upload-progress');
            
            progressContainer.classList.remove('hidden');
            
            const uploadedUrls = [];
            
            for (let i = 0; i < images.length; i++) {
                const image = images[i];
                const progress = ((i + 1) / images.length) * 100;
                progressBar.style.width = progress + '%';
                
                try {
                    const response = await fetch(appsScriptUrl, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'uploadImage',
                            imageData: image.data,
                            fileName: `${type}_${Date.now()}_${image.name}`,
                            mimeType: image.type
                        })
                    });
                    
                    const text = await response.text();
                    const result = JSON.parse(text);
                    
                    if (result.success) {
                        uploadedUrls.push({
                            name: image.name,
                            url: result.directUrl,
                            viewUrl: result.viewUrl
                        });
                    } else {
                        console.error('Upload failed:', result.error);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            
            return uploadedUrls;
        }

        // Auto-connect on page load
        window.addEventListener('load', function() {
            if (appsScriptUrl) {
                connectToAppsScript();
            }
        });

        // Tab navigation
        function showTab(tab) {
            // Hide all sections
            document.getElementById('borrowSection').classList.add('hidden');
            document.getElementById('returnSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');

            // Remove active class from all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(t => {
                t.classList.remove('border-indigo-500', 'text-indigo-600');
                t.classList.add('text-gray-500');
            });

            // Show selected section and activate tab
            document.getElementById(tab + 'Section').classList.remove('hidden');
            document.getElementById(tab + 'Tab').classList.add('border-indigo-500', 'text-indigo-600');
            document.getElementById(tab + 'Tab').classList.remove('text-gray-500');

            if (tab === 'return') {
                loadBorrowList();
            } else if (tab === 'history') {
                loadHistory();
            }
        }

        // Apps Script connection with detailed error handling
        function connectToAppsScript() {
            if (!appsScriptUrl) {
                showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö Apps Script URL', 'error');
                return;
            }
            
            // Test connection with detailed logging
            fetch(url, {
                method: 'GET',
                mode: 'cors'
            })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    console.log('Raw response:', text);
                    
                    try {
                        const data = JSON.parse(text);
                        console.log('Parsed data:', data);
                        
                        if (data.success !== undefined) {
                            isConnected = true;
                            showMessage('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
                            
                            // Load existing data
                            loadDataFromAppsScript();
                            
                            // Enable Drive functionality
                            driveEnabled = true;
                        } else {
                            throw new Error('Response format ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                        }
                    } catch (parseError) {
                        console.error('JSON Parse Error:', parseError);
                        
                        // Check if it's HTML error page
                        if (text.includes('<html>') || text.includes('<!DOCTYPE')) {
                            throw new Error('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö HTML ‡πÅ‡∏ó‡∏ô JSON - ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô Error Page ‡∏´‡∏£‡∏∑‡∏≠ Permission ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                        } else {
                            throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á Response ‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÑ‡∏î‡πâ: ' + text.substring(0, 200));
                        }
                    }
                })
                .catch(error => {
                    console.error('Connection error:', error);
                    
                    let errorMsg = error.message;
                    if (error.message.includes('CORS')) {
                        errorMsg = 'CORS Error - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy ‡πÉ‡∏ô Apps Script';
                    } else if (error.message.includes('404')) {
                        errorMsg = '‡πÑ‡∏°‡πà‡∏û‡∏ö URL - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Apps Script URL';
                    } else if (error.message.includes('403')) {
                        errorMsg = 'Permission Denied - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ "Who has access" ‡πÄ‡∏õ‡πá‡∏ô Anyone';
                    }
                    
                    showMessage('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + errorMsg, 'error');
                });
        }

        function showAppsScriptGuide() {
            document.getElementById('guideModal').classList.remove('hidden');
        }

        function closeGuide() {
            document.getElementById('guideModal').classList.add('hidden');
        }

        // Load data from Apps Script
        function loadDataFromAppsScript() {
            if (!appsScriptUrl) return;
            
            fetch(appsScriptUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        // Convert Apps Script data to local format
                        const records = data.data.map(record => ({
                            id: record.ID || record.id,
                            borrowerName: record['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°'] || record.borrowerName,
                            borrowerPhone: record['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || record.borrowerPhone,
                            itemName: record['‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á'] || record.itemName,
                            quantity: record['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] || record.quantity,
                            borrowDate: record['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°'] || record.borrowDate,
                            returnDate: record['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô'] || record.returnDate,
                            actualReturnDate: record['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á'] || record.actualReturnDate,
                            condition: record['‡∏™‡∏†‡∏≤‡∏û'] || record.condition,
                            status: record['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || record.status,
                            notes: record['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'] || record.notes,
                            returnNotes: record['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô'] || record.returnNotes,
                            borrowImageUrls: record['‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏°'] || record.borrowImageUrls || '',
                            returnImageUrls: record['‡∏£‡∏π‡∏õ‡∏Ñ‡∏∑‡∏ô'] || record.returnImageUrls || ''
                        }));
                        
                        localStorage.setItem('borrowRecords', JSON.stringify(records));
                        showMessage(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    showMessage('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message, 'error');
                });
        }

        // Borrow form submission
        document.getElementById('borrowForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Upload images to Google Drive first
            const uploadedImages = await uploadImagesToDrive(borrowImages, 'borrow');
            const imageUrls = uploadedImages.map(img => `${img.name}: ${img.viewUrl}`).join('\n');
            
            const borrowData = {
                id: Date.now().toString(),
                borrowerName: document.getElementById('borrowerName').value,
                borrowerPhone: document.getElementById('borrowerPhone').value,
                itemName: document.getElementById('itemName').value,
                quantity: document.getElementById('quantity').value,
                borrowDate: document.getElementById('borrowDate').value,
                returnDate: document.getElementById('returnDate').value,
                notes: document.getElementById('notes').value,
                status: '‡∏¢‡∏∑‡∏°',
                timestamp: new Date().toISOString(),
                borrowImages: [...borrowImages],
                borrowImageUrls: imageUrls,
                driveImages: uploadedImages
            };

            // Save to localStorage
            saveBorrowRecord(borrowData);
            
            // Save to Apps Script if connected
            if (isConnected && appsScriptUrl) {
                saveToAppsScript(borrowData);
            }
            
            // Reset form and clear images
            this.reset();
            document.getElementById('borrowDate').value = new Date().toISOString().split('T')[0];
            borrowImages.length = 0;
            document.getElementById('borrowImagePreview').innerHTML = '';
            
            if (uploadedImages.length > 0) {
                showMessage(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ${uploadedImages.length} ‡∏£‡∏π‡∏õ‡πÑ‡∏õ Google Drive ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            } else {
                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }
        });

        // Return form submission
        document.getElementById('returnForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Upload images to Google Drive first
            const uploadedImages = await uploadImagesToDrive(returnImages, 'return');
            const imageUrls = uploadedImages.map(img => `${img.name}: ${img.viewUrl}`).join('\n');
            
            const borrowId = document.getElementById('returnBorrowId').value;
            const returnData = {
                actualReturnDate: document.getElementById('actualReturnDate').value,
                condition: document.getElementById('condition').value,
                returnNotes: document.getElementById('returnNotes').value,
                returnTimestamp: new Date().toISOString(),
                returnImages: [...returnImages],
                returnImageUrls: imageUrls,
                driveReturnImages: uploadedImages
            };

            updateBorrowRecord(borrowId, returnData);
            
            // Update in Apps Script if connected
            if (isConnected && appsScriptUrl) {
                updateInAppsScript(borrowId, returnData);
            }
            
            // Reset form and hide it
            this.reset();
            this.classList.add('hidden');
            document.getElementById('actualReturnDate').value = new Date().toISOString().split('T')[0];
            returnImages.length = 0;
            document.getElementById('returnImagePreview').innerHTML = '';
            
            if (uploadedImages.length > 0) {
                showMessage(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ${uploadedImages.length} ‡∏£‡∏π‡∏õ‡πÑ‡∏õ Google Drive ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            } else {
                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }
            loadBorrowList();
        });

        // Save to Apps Script with better error handling
        function saveToAppsScript(data) {
            const payload = {
                action: 'add',
                id: data.id,
                borrowerName: data.borrowerName,
                borrowerPhone: data.borrowerPhone,
                itemName: data.itemName,
                quantity: data.quantity,
                borrowDate: data.borrowDate,
                returnDate: data.returnDate,
                actualReturnDate: '',
                condition: '',
                status: data.status,
                notes: data.notes,
                returnNotes: '',
                borrowImageUrls: data.borrowImageUrls || '',
                returnImageUrls: ''
            };

            console.log('Sending payload to Apps Script:', payload);

            fetch(appsScriptUrl, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                return response.text();
            })
            .then(text => {
                console.log('Raw response:', text);
                try {
                    const result = JSON.parse(text);
                    console.log('Parsed result:', result);
                    if (result.success) {
                        showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    } else {
                        console.error('Apps Script save error:', result.error);
                        showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (result.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'), 'error');
                    }
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    if (text.includes('<html>') || text.includes('<!DOCTYPE')) {
                        showMessage('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö HTML ‡πÅ‡∏ó‡∏ô JSON - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Apps Script', 'error');
                    } else {
                        showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÑ‡∏î‡πâ', 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Error saving to Apps Script:', error);
                let errorMsg = error.message;
                if (error.message.includes('CORS')) {
                    errorMsg = 'CORS Error - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞ Internet';
                }
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + errorMsg, 'error');
            });
        }

        // Update in Apps Script
        function updateInAppsScript(id, returnData) {
            const payload = {
                action: 'update',
                id: id,
                actualReturnDate: returnData.actualReturnDate,
                condition: returnData.condition,
                returnNotes: returnData.returnNotes,
                returnImageUrls: returnData.returnImageUrls || ''
            };

            console.log('Sending update payload to Apps Script:', payload);

            fetch(appsScriptUrl, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('Update response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('Update raw response:', text);
                try {
                    const result = JSON.parse(text);
                    console.log('Update parsed result:', result);
                    if (result.success) {
                        showMessage('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    } else {
                        console.error('Apps Script update error:', result.error);
                        showMessage('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Google Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (result.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'), 'error');
                    }
                } catch (parseError) {
                    console.error('Update JSON Parse Error:', parseError);
                    if (text.includes('<html>') || text.includes('<!DOCTYPE')) {
                        showMessage('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö HTML ‡πÅ‡∏ó‡∏ô JSON - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Apps Script', 'error');
                    } else {
                        showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÑ‡∏î‡πâ', 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Error updating in Apps Script:', error);
                let errorMsg = error.message;
                if (error.message.includes('CORS')) {
                    errorMsg = 'CORS Error - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞ Internet';
                }
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' + errorMsg, 'error');
            });
        }

        // Save borrow record
        function saveBorrowRecord(data) {
            let records = JSON.parse(localStorage.getItem('borrowRecords') || '[]');
            records.push(data);
            localStorage.setItem('borrowRecords', JSON.stringify(records));
        }

        // Update borrow record with return info
        function updateBorrowRecord(id, returnData) {
            let records = JSON.parse(localStorage.getItem('borrowRecords') || '[]');
            const index = records.findIndex(r => r.id === id);
            if (index !== -1) {
                records[index] = { ...records[index], ...returnData, status: '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' };
                localStorage.setItem('borrowRecords', JSON.stringify(records));
            }
        }

        // Load borrow list for return
        function loadBorrowList() {
            const records = JSON.parse(localStorage.getItem('borrowRecords') || '[]');
            const activeRecords = records.filter(r => r.status === '‡∏¢‡∏∑‡∏°');
            const borrowList = document.getElementById('borrowList');
            
            if (activeRecords.length === 0) {
                borrowList.innerHTML = '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</p>';
                return;
            }

            borrowList.innerHTML = activeRecords.map(record => `
                <div class="border border-gray-200 rounded-md p-4 hover:bg-gray-50 cursor-pointer" 
                     onclick="selectForReturn('${record.id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-800">${record.itemName}</h4>
                            <p class="text-sm text-gray-600">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${record.borrowerName}</p>
                            <p class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${record.quantity}</p>
                            <p class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${formatDate(record.borrowDate)}</p>
                            <p class="text-sm text-gray-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                        </div>
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">
                            ${record.status}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Select item for return
        function selectForReturn(id) {
            const records = JSON.parse(localStorage.getItem('borrowRecords') || '[]');
            const record = records.find(r => r.id === id);
            
            if (record) {
                document.getElementById('returnBorrowId').value = id;
                document.getElementById('returnItemInfo').innerHTML = `
                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á:</strong> ${record.itemName}</p>
                    <p><strong>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°:</strong> ${record.borrowerName}</p>
                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${record.quantity}</p>
                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°:</strong> ${formatDate(record.borrowDate)}</p>
                    <p><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô:</strong> ${formatDate(record.returnDate)}</p>
                `;
                document.getElementById('returnForm').classList.remove('hidden');
            }
        }

        // Load history
        function loadHistory() {
            // Refresh from Apps Script if connected
            if (isConnected && appsScriptUrl) {
                loadDataFromAppsScript();
            }
            
            const records = JSON.parse(localStorage.getItem('borrowRecords') || '[]');
            const historyList = document.getElementById('historyList');
            
            if (records.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</p>';
                return;
            }

            historyList.innerHTML = records.map(record => `
                <div class="border border-gray-200 rounded-md p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-800">${record.itemName}</h4>
                            <div class="grid md:grid-cols-2 gap-4 mt-2 text-sm text-gray-600">
                                <div>
                                    <p>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${record.borrowerName}</p>
                                    <p>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${record.borrowerPhone}</p>
                                    <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${record.quantity}</p>
                                </div>
                                <div>
                                    <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${formatDate(record.borrowDate)}</p>
                                    <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                                    ${record.actualReturnDate ? `<p>‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á: ${formatDate(record.actualReturnDate)}</p>` : ''}
                                    ${record.condition ? `<p>‡∏™‡∏†‡∏≤‡∏û: ${record.condition}</p>` : ''}
                                </div>
                            </div>
                            ${record.notes ? `<p class="text-sm text-gray-600 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${record.notes}</p>` : ''}
                            ${record.returnNotes ? `<p class="text-sm text-gray-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô: ${record.returnNotes}</p>` : ''}
                            
                            ${record.driveImages && record.driveImages.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium text-gray-700">üîó ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (Google Drive):</p>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-1">
                                        ${record.driveImages.map(img => `
                                            <div class="text-center">
                                                <img src="${img.url}" alt="${img.name}" 
                                                     class="w-full h-16 object-cover rounded border cursor-pointer hover:opacity-80"
                                                     onclick="showImageModal('${img.url}', '${img.name}')">
                                                <a href="${img.viewUrl}" target="_blank" rel="noopener noreferrer" 
                                                   class="text-xs text-blue-600 hover:underline block mt-1">‡∏î‡∏π‡πÉ‡∏ô Drive</a>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : record.borrowImages && record.borrowImages.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium text-gray-700">üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°:</p>
                                    <div class="grid grid-cols-4 gap-2 mt-1">
                                        ${record.borrowImages.map(img => `
                                            <img src="${img.data}" alt="${img.name}" 
                                                 class="w-full h-16 object-cover rounded border cursor-pointer hover:opacity-80"
                                                 onclick="showImageModal('${img.data}', '${img.name}')">
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${record.driveReturnImages && record.driveReturnImages.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium text-gray-700">üîó ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô (Google Drive):</p>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-1">
                                        ${record.driveReturnImages.map(img => `
                                            <div class="text-center">
                                                <img src="${img.url}" alt="${img.name}" 
                                                     class="w-full h-16 object-cover rounded border cursor-pointer hover:opacity-80"
                                                     onclick="showImageModal('${img.url}', '${img.name}')">
                                                <a href="${img.viewUrl}" target="_blank" rel="noopener noreferrer" 
                                                   class="text-xs text-blue-600 hover:underline block mt-1">‡∏î‡∏π‡πÉ‡∏ô Drive</a>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : record.returnImages && record.returnImages.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium text-gray-700">üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô:</p>
                                    <div class="grid grid-cols-4 gap-2 mt-1">
                                        ${record.returnImages.map(img => `
                                            <img src="${img.data}" alt="${img.name}" 
                                                 class="w-full h-16 object-cover rounded border cursor-pointer hover:opacity-80"
                                                 onclick="showImageModal('${img.data}', '${img.name}')">
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs ${
                            record.status === '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${record.status}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Search functionality
        document.getElementById('searchBorrow').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const records = JSON.parse(localStorage.getItem('borrowRecords') || '[]');
            const filteredRecords = records.filter(r => 
                r.status === '‡∏¢‡∏∑‡∏°' && 
                (r.borrowerName.toLowerCase().includes(searchTerm) || 
                 r.itemName.toLowerCase().includes(searchTerm))
            );
            
            const borrowList = document.getElementById('borrowList');
            if (filteredRecords.length === 0) {
                borrowList.innerHTML = '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
                return;
            }

            borrowList.innerHTML = filteredRecords.map(record => `
                <div class="border border-gray-200 rounded-md p-4 hover:bg-gray-50 cursor-pointer" 
                     onclick="selectForReturn('${record.id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-800">${record.itemName}</h4>
                            <p class="text-sm text-gray-600">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${record.borrowerName}</p>
                            <p class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${record.quantity}</p>
                            <p class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${formatDate(record.borrowDate)}</p>
                            <p class="text-sm text-gray-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                        </div>
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">
                            ${record.status}
                        </span>
                    </div>
                </div>
            `).join('');
        });

        // History search
        document.getElementById('historySearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const records = JSON.parse(localStorage.getItem('borrowRecords') || '[]');
            const filteredRecords = records.filter(r => 
                r.borrowerName.toLowerCase().includes(searchTerm) || 
                r.itemName.toLowerCase().includes(searchTerm)
            );
            
            const historyList = document.getElementById('historyList');
            if (filteredRecords.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
                return;
            }

            // Use same display logic as loadHistory but with filtered records
            historyList.innerHTML = filteredRecords.map(record => `
                <div class="border border-gray-200 rounded-md p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-800">${record.itemName}</h4>
                            <div class="grid md:grid-cols-2 gap-4 mt-2 text-sm text-gray-600">
                                <div>
                                    <p>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${record.borrowerName}</p>
                                    <p>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${record.borrowerPhone}</p>
                                    <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${record.quantity}</p>
                                </div>
                                <div>
                                    <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${formatDate(record.borrowDate)}</p>
                                    <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                                    ${record.actualReturnDate ? `<p>‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á: ${formatDate(record.actualReturnDate)}</p>` : ''}
                                    ${record.condition ? `<p>‡∏™‡∏†‡∏≤‡∏û: ${record.condition}</p>` : ''}
                                </div>
                            </div>
                            ${record.notes ? `<p class="text-sm text-gray-600 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${record.notes}</p>` : ''}
                            ${record.returnNotes ? `<p class="text-sm text-gray-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô: ${record.returnNotes}</p>` : ''}
                            
                            ${record.driveImages && record.driveImages.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium text-gray-700">üîó ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (Google Drive):</p>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-1">
                                        ${record.driveImages.map(img => `
                                            <div class="text-center">
                                                <img src="${img.url}" alt="${img.name}" 
                                                     class="w-full h-16 object-cover rounded border cursor-pointer hover:opacity-80"
                                                     onclick="showImageModal('${img.url}', '${img.name}')">
                                                <a href="${img.viewUrl}" target="_blank" rel="noopener noreferrer" 
                                                   class="text-xs text-blue-600 hover:underline block mt-1">‡∏î‡∏π‡πÉ‡∏ô Drive</a>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : record.borrowImages && record.borrowImages.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium text-gray-700">üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°:</p>
                                    <div class="grid grid-cols-4 gap-2 mt-1">
                                        ${record.borrowImages.map(img => `
                                            <img src="${img.data}" alt="${img.name}" 
                                                 class="w-full h-16 object-cover rounded border cursor-pointer hover:opacity-80"
                                                 onclick="showImageModal('${img.data}', '${img.name}')">
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${record.driveReturnImages && record.driveReturnImages.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium text-gray-700">üîó ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô (Google Drive):</p>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-1">
                                        ${record.driveReturnImages.map(img => `
                                            <div class="text-center">
                                                <img src="${img.url}" alt="${img.name}" 
                                                     class="w-full h-16 object-cover rounded border cursor-pointer hover:opacity-80"
                                                     onclick="showImageModal('${img.url}', '${img.name}')">
                                                <a href="${img.viewUrl}" target="_blank" rel="noopener noreferrer" 
                                                   class="text-xs text-blue-600 hover:underline block mt-1">‡∏î‡∏π‡πÉ‡∏ô Drive</a>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : record.returnImages && record.returnImages.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-sm font-medium text-gray-700">üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô:</p>
                                    <div class="grid grid-cols-4 gap-2 mt-1">
                                        ${record.returnImages.map(img => `
                                            <img src="${img.data}" alt="${img.name}" 
                                                 class="w-full h-16 object-cover rounded border cursor-pointer hover:opacity-80"
                                                 onclick="showImageModal('${img.data}', '${img.name}')">
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs ${
                            record.status === '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${record.status}
                        </span>
                    </div>
                </div>
            `).join('');
        });

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH');
        }

        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // Image modal functions
        function showImageModal(imageSrc, imageName) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('modalImageName').textContent = imageName;
            document.getElementById('imageModal').classList.remove('hidden');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fc766c53bff4cf',t:'MTc2MDY2OTE1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
